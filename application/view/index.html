<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Index</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link href="css/index.css" rel="stylesheet">
    <script type="text/javascript" src="js/map-report.js"></script>
    <style>
        #map {height: 100%; width: 60%;}
        </style>
</head>

<body onload="checkCookie(); requestAccess(); getCategories(); getLocations()">
    <div class="topnav">
            <div style="background:whitesmoke;margin: 0px">
                    <h2 style="text-align:center">This is a Test website</h2>
            </div>
                
        <a class="active" href="/index">Home</a>
        <a href="/team">Team</a>
        <a href="/about">About</a>

        <div class="login-container">
            <form action="/action_page.php">
                <a href="/login" type="submit" id="loginBtn" style="visibility: hidden">Login</a>
                <a href="/register" type="submit" id="registerBtn" style="visibility: hidden">Register</a>
                <button type="button" onclick="logout()" id="logoutBtn" style="display: none">Logout</button>
            </form>
        </div>
    </div>

    <div class="header">
        <form>
        	<div>
	            <h1>Safe SF         Team 2</h1>
	            
            </div>
            
            <h2>Lets Start your search</h1>
            <div class="form-box">
                <div class="dropdown">
                    <button class="dropbtn" id="categoryButton">Categories</button>
                    <div class="dropdown-content" id="categoryDropDown">
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn" id="locationButton">Locations</button>
                    <div class="dropdown-content" id="locationDropDown">
                    </div>
                </div>

                <input class="search-field search" id="searchBox" name="location" type="text" placeholder="search"/>
                <button class="search-btn" type="button" onclick="search()">search</button>
            </div>
        </form>

        <div class="split_left" id="table">
        </div>
        <div class="split_right" id="map">
                <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyuM-hX7dGj7gXBfLXyuwvAEhZo4sxj18&callback=initMap"
                async defer></script>
        </div>
    </div>

    <script>
        var categories;
        var locations;

        function checkCookie() {
        	var cookies = document.cookie.split(';');
        	var cookiePresent = false;

        	for(var i = 0; i < cookies.length; i++) {
        		if(cookies[i].startsWith('accessToken=')) {
            		cookiePresent = true;
        			break;
        		}
        	}

        	if(cookiePresent) {
			    document.getElementById("loginBtn").style.visibility = 'hidden';
        		document.getElementById("registerBtn").style.visibility = 'hidden';
        		document.getElementById("logoutBtn").style = 'display: block';
        	}
        	else {
        		document.getElementById("loginBtn").style.visibility = 'visible';
        		document.getElementById("registerBtn").style.visibility = 'visible';
        		document.getElementById("logoutBtn").style = 'display: none';
        	}
        }

        function requestAccess() {
            var xmlReq = new XMLHttpRequest();

            xmlReq.onload = function() {
                if (xmlReq.status == 200) {
                	if(xmlReq.response.authenticated) {
                		document.getElementById("loginBtn").style.visibility = 'hidden';
                		document.getElementById("registerBtn").style.visibility = 'hidden';
                		document.getElementById("logoutBtn").style = 'display: block';
	                }
	                else {
		        		document.getElementById("loginBtn").style.visibility = 'visible';
		        		document.getElementById("registerBtn").style.visibility = 'visible';
		        		document.getElementById("logoutBtn").style = 'display: none';

		        		if(xmlReq.response.errMessage)
		        			alert(xmlReq.response.errMessage)
	                }
                }
            }

            xmlReq.open('GET', '/requestAccess', true);
            xmlReq.responseType = "json";
            xmlReq.send(null);
        }

        function logout() {
            var xmlReq = new XMLHttpRequest();

            xmlReq.onload = function() {
                if (xmlReq.status == 200)
                    window.location.href = "index.html";
            }

            xmlReq.open('GET', '/requestLogout', true);
            xmlReq.send(null);
        }

        function getCategories() {
            var xmlReq = new XMLHttpRequest();

            xmlReq.onload = function() {
                if (xmlReq.status == 200) {
                    categories = xmlReq.response
                    populateDropdown(categories, "category");
                }
            }

            xmlReq.open('GET', '/categories', true);
            xmlReq.responseType = "json";
            xmlReq.send();
        }

        function getLocations() {
            var xmlReq = new XMLHttpRequest();

            xmlReq.onload = function() {
                if (xmlReq.status == 200) {
                    locations = xmlReq.response
                    populateDropdown(locations, "location");
                }
            }

            xmlReq.open('GET', '/locations', true);
            xmlReq.responseType = "json";
            xmlReq.send();
        }

        function populateDropdown(jsonData, field) {
            if(field === "category")
                var dropDown = document.getElementById("categoryDropDown");
            else if(field === "location")
                var dropDown = document.getElementById("locationDropDown");

            var div = document.createElement("div");
            div.innerHTML = "<a href='javascript:void(0);' onclick=\"selectDropdown('None', '" + field + "')\">None</a>";
            dropDown.appendChild(div);

            for(var i = 0; i < jsonData.length; i++) {
                if(field === "category")
                    var selection = jsonData[i].category;
                else if(field === "location")
                    var selection = jsonData[i].location;

                div = document.createElement("div");
                div.innerHTML = "<a href='javascript:void(0);' onclick=\"selectDropdown('" + selection + "', '" + field + "')\">" + selection + "</a>";
                dropDown.appendChild(div);
            }
        }

        function selectDropdown(selection, field) {
            if(field === "category")
                var dropDownButton = "categoryButton";
            else if(field === "location")
                var dropDownButton = "locationButton";

            var button = document.getElementById(dropDownButton);

            if(selection === "None") {
                if(field === "category")
                    button.innerHTML = "Categories";
                else if(field === "location")
                    button.innerHTML = "Locations";
            }
            else
                button.innerHTML = selection;
        }

    	function search() {
    		var xmlReq = new XMLHttpRequest();

			xmlReq.onload = function() {
				if (xmlReq.status == 200)
                    createTable(xmlReq.response);
			}

			xmlReq.open('GET', '/search' + getSearchParams(), true);
			xmlReq.responseType = "json";
			xmlReq.send(null);
    	}

    	function getSearchParams() {
    		var category = document.getElementById("categoryButton").innerHTML;
    		var category_id = getIdOfValue(categories, "category", category);

    		var location = document.getElementById("locationButton").innerHTML;
    		var location_id = getIdOfValue(locations, "location", location);

    		var user_entry = document.getElementById("searchBox").value;

    		var requestParam = "?"
    		var firstParam = true;

    		if(category != "Categories") {
    			requestParam += "category_id=" + category_id;
    			firstParam = false;
    		}

    		if(location != "Locations") {
	    		if(!firstParam)
	    			requestParam += "&";

    			requestParam += "location_id=" + location_id;
    			firstParam = false;
    		}

    		if(user_entry != "") {
	    		if(!firstParam)
	    			requestParam += "&";
	    		
    			requestParam += "user_entry=" + user_entry;
    		}

    		return requestParam;
    	}

    	function getIdOfValue(jsonData, field, value) {
    		for(var i = 0; i < jsonData.length; i++) {
    			if(field === "category") {
    				if(jsonData[i].category === value)
    					return jsonData[i].category_id;
    			}
    			else if(field === "location") {
    				if(jsonData[i].location === value)
    					return jsonData[i].location_id;
    			}
    		}
    	}

        function getValueOfId(jsonData, field, id) {
            for(var i = 0; i < jsonData.length; i++) {
                if(field === "category_id") {
                    if(jsonData[i].category_id === id)
                        return jsonData[i].category;
                }
                else if(field === "location_id") {
                    if(jsonData[i].location_id === id)
                        return jsonData[i].location;
                }
            }
        }

        function createTable(searchResults) {
            var table = document.createElement("table");

            for(var i = 0; i < Math.ceil(searchResults.length); i++)
            {
                var row = table.insertRow(-1);

                var cell = row.insertCell(-1);

                        var report = searchResults[i];
                        var category = getValueOfId(categories, "category_id", report.category_id);
                        var image = "report_images/" + report.report_id + ".jpg";

                        if(locations[parseInt(report.location_id) - 1] == null)
                        	var location = "";
                        else
                            var location = getValueOfId(locations, "location_id", report.location_id);

                        cell.innerHTML = "<div class='card'>" +
                                          "<img class='cardImage' src='" + image + "'><div>" +
                                          category + "</div><div>" +
                                          report.details + "</div><div>" +
                                          location + "</div><div>" +
                                          report.insert_date + "</div><div>" +
                                          report.status + "</div></div>";
                    }
            
             

            var tableContainer = document.getElementById("table");
            tableContainer.innerHTML = "";
            tableContainer.appendChild(table);
        }
    </script>
</body>

</html>